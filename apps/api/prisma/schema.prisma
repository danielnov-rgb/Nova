// Nova - Product Intelligence Platform
// Multi-tenant database schema

generator client {
  provider        = "prisma-client-js"
  output          = "../node_modules/.prisma/client"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [vector]
}

// ============================================================================
// MULTI-TENANCY & AUTH
// ============================================================================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  domain    String?  @unique
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users             User[]
  clientContexts    ClientContext[]
  problems          Problem[]
  votingSessions    VotingSession[]
  solutions         Solution[]
  audiences         TargetAudience[]
  voterGroups       VoterGroup[]
  sprints           Sprint[]
  weightingProfiles WeightingProfile[]
  problemGroups     ProblemGroup[]
  features          Feature[]
  pluginConfig      PluginConfig?

  @@map("tenants")
}

model User {
  id           String   @id @default(cuid())
  tenantId     String
  email        String
  passwordHash String
  role         UserRole @default(MEMBER)
  firstName    String?
  lastName     String?
  avatarUrl    String?
  isDemoMode   Boolean  @default(false) // Demo users can interact but changes don't persist
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant            Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  votes             Vote[]
  voterSessions     VoterSession[]
  groupMemberships  VoterGroupMembership[]
  codeRedemptions   TeamCodeRedemption[]
  problemComments   ProblemComment[]
  problemFavourites ProblemFavourite[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("users")
}

enum UserRole {
  FDE // Forward Deployed Engineer (super admin)
  ADMIN // Client admin
  MEMBER // Client team member
  VOTER // External voter (limited access)
}

// ============================================================================
// CLIENT ONBOARDING
// ============================================================================

model ClientContext {
  id                    String   @id @default(cuid())
  tenantId              String   @unique
  objectives            String?  @db.Text
  businessModel         String?  @db.Text
  competitiveAdvantages String?  @db.Text
  existingProblems      String?  @db.Text
  designSystemUrl       String?
  gitRepoUrl            String?
  terminologyGlossary   Json     @default("{}")
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("client_contexts")
}

// ============================================================================
// TARGET AUDIENCE
// ============================================================================

model TargetAudience {
  id        String             @id @default(cuid())
  tenantId  String
  name      String
  type      TargetAudienceType
  segments  Json               @default("[]") // Array of segment definitions
  targets   Json               @default("{}") // Numeric targets per segment
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("target_audiences")
}

enum TargetAudienceType {
  EXISTING // Current customer base
  TARGET // Desired acquisition targets
  MARKET // Market demographics
}

// ============================================================================
// MARKET INTELLIGENCE
// ============================================================================

model MarketIntelligence {
  id        String                   @id @default(cuid())
  tenantId  String
  category  MarketIntelligenceCategory
  title     String
  value     String?
  source    String?
  notes     String?                  @db.Text
  metadata  Json                     @default("{}")
  createdAt DateTime                 @default(now())
  updatedAt DateTime                 @updatedAt

  @@index([tenantId])
  @@index([category])
  @@map("market_intelligence")
}

enum MarketIntelligenceCategory {
  INDUSTRY    // Industry overview and trends
  BENCHMARK   // Performance benchmarks
  ECONOMIC    // Economic indicators
  PRICING     // Pricing intelligence
  DEMOGRAPHIC // Market demographics
}

// ============================================================================
// COMPETITOR RESEARCH
// ============================================================================

model Competitor {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  website     String?
  description String?  @db.Text
  strengths   Json     @default("[]")
  weaknesses  Json     @default("[]")
  pricing     Json     @default("{}")
  solutions   Json     @default("[]") // What problems they solve
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@map("competitors")
}

// ============================================================================
// VOTER GROUPS & TEAM CODES
// ============================================================================

model VoterGroup {
  id             String         @id @default(cuid())
  tenantId       String
  name           String
  type           VoterGroupType
  description    String?        @db.Text
  defaultCredits Int            @default(10) // Use creditsOverride in VotingSessionGroup for per-session adjustments
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  tenant        Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  teamCodes     TeamCode[]
  memberships   VoterGroupMembership[]
  sessionGroups VotingSessionGroup[]
  votes         Vote[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("voter_groups")
}

enum VoterGroupType {
  LEADERSHIP // Internal stakeholders, high-weight
  PROJECT_TEAM // Strategy, marketing, design, dev teams
  EXTERNAL_USER // Real users, external audience
}

model TeamCode {
  id           String    @id @default(cuid())
  voterGroupId String
  code         String    @unique
  description  String?
  maxUses      Int? // null = unlimited
  usesCount    Int       @default(0)
  expiresAt    DateTime?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  voterGroup  VoterGroup           @relation(fields: [voterGroupId], references: [id], onDelete: Cascade)
  redemptions TeamCodeRedemption[]

  @@index([code])
  @@map("team_codes")
}

model TeamCodeRedemption {
  id         String   @id @default(cuid())
  teamCodeId String
  userId     String
  redeemedAt DateTime @default(now())

  // Relations
  teamCode TeamCode @relation(fields: [teamCodeId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamCodeId, userId])
  @@map("team_code_redemptions")
}

model VoterGroupMembership {
  id           String     @id @default(cuid())
  userId       String
  voterGroupId String
  joinedVia    JoinMethod
  joinedAt     DateTime   @default(now())

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  voterGroup VoterGroup @relation(fields: [voterGroupId], references: [id], onDelete: Cascade)

  @@unique([userId, voterGroupId])
  @@map("voter_group_memberships")
}

enum JoinMethod {
  TEAM_CODE // Joined via team code
  EMAIL_LINK // Joined via email invite
  ADMIN_ADD // Added by admin
  PUBLIC // Joined public session
}

model VotingSessionGroup {
  id              String   @id @default(cuid())
  votingSessionId String
  voterGroupId    String
  creditsOverride Int? // Override default credits for this group
  createdAt       DateTime @default(now())

  // Relations
  votingSession VotingSession @relation(fields: [votingSessionId], references: [id], onDelete: Cascade)
  voterGroup    VoterGroup    @relation(fields: [voterGroupId], references: [id], onDelete: Cascade)

  @@unique([votingSessionId, voterGroupId])
  @@map("voting_session_groups")
}

// ============================================================================
// SPRINTS
// ============================================================================

model Sprint {
  id          String       @id @default(cuid())
  tenantId    String
  name        String
  description String?      @db.Text
  startDate   DateTime?
  endDate     DateTime?
  status      SprintStatus @default(PLANNING)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  problems       Problem[]
  votingSessions VotingSession[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("sprints")
}

enum SprintStatus {
  PLANNING
  ACTIVE
  COMPLETED
  ARCHIVED
}

// ============================================================================
// PROBLEM DISCOVERY & VOTING
// ============================================================================

model Problem {
  id          String                       @id @default(cuid())
  tenantId    String
  sprintId    String? // Optional sprint categorization
  title       String
  description String?                      @db.Text
  hypothesis  String?                      @db.Text // "We believe that..." statement

  // Source & Evidence
  source          ProblemSource                @default(MANUAL)
  evidenceItems   Json                         @default("[]") // Array of EvidenceItem
  evidenceSummary String?                      @db.Text // AI-generated summary
  embedding       Unsupported("vector(1536)")?

  // Scoring (all 11 attributes with metadata)
  scores        Json   @default("{}") // ScoreWithMeta objects
  priorityScore Float? // Computed from weights

  // Organization
  status         ProblemStatus @default(DISCOVERED)
  isShortlisted  Boolean       @default(false)
  shortlistOrder Int? // Manual ordering in shortlist
  tags           String[]

  // Metadata
  lastScoredAt DateTime?
  lastScoredBy String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant         Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sprint         Sprint?                   @relation(fields: [sprintId], references: [id], onDelete: SetNull)
  votingSessions VotingSessionProblem[]
  votes          Vote[]
  solutions      Solution[]
  groups         ProblemGroupMembership[]
  comments       ProblemComment[]
  favourites     ProblemFavourite[]

  @@index([tenantId])
  @@index([sprintId])
  @@index([status])
  @@index([isShortlisted])
  @@index([priorityScore])
  @@map("problems")
}

enum ProblemSource {
  SYNTHETIC_INTERVIEW // Generated from AI interviews
  MANUAL // Manually entered
  IMPORT // Imported from CSV/JSON
  RESEARCH // From competitor/market research
}

enum ProblemStatus {
  DISCOVERED // Initial discovery
  SHORTLISTED // Selected for consideration
  BACKLOG // In the problem backlog
  IN_PROGRESS // Being worked on
  SOLVED // Solution implemented
  DISCARDED // Not pursuing
}

// ============================================================================
// WEIGHTING PROFILES
// ============================================================================

model WeightingProfile {
  id          String  @id @default(cuid())
  tenantId    String
  name        String
  description String?
  isDefault   Boolean @default(false)
  weights     Json // Weight values for each scoring attribute

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("weighting_profiles")
}

// ============================================================================
// PROBLEM GROUPS
// ============================================================================

model ProblemGroup {
  id          String  @id @default(cuid())
  tenantId    String
  name        String
  description String?
  color       String? // Hex color for UI
  icon        String? // Icon name

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant   Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  problems ProblemGroupMembership[]

  @@index([tenantId])
  @@map("problem_groups")
}

model ProblemGroupMembership {
  id        String   @id @default(cuid())
  problemId String
  groupId   String
  addedAt   DateTime @default(now())
  addedBy   String?

  // Relations
  problem Problem      @relation(fields: [problemId], references: [id], onDelete: Cascade)
  group   ProblemGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([problemId, groupId])
  @@index([problemId])
  @@index([groupId])
  @@map("problem_group_memberships")
}

// ============================================================================
// PROBLEM COMMENTS & FAVOURITES
// ============================================================================

model ProblemComment {
  id        String   @id @default(cuid())
  problemId String
  userId    String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  problem Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([problemId])
  @@index([userId])
  @@map("problem_comments")
}

model ProblemFavourite {
  id        String   @id @default(cuid())
  problemId String
  userId    String
  createdAt DateTime @default(now())

  // Relations
  problem Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([problemId, userId])
  @@index([userId])
  @@map("problem_favourites")
}

model VotingSession {
  id             String              @id @default(cuid())
  tenantId       String
  sprintId       String? // Optional: associate with specific sprint
  title          String
  description    String?             @db.Text
  deadline       DateTime?
  status         VotingSessionStatus @default(DRAFT)
  sessionType    SessionType         @default(THEMATIC)
  config         Json                @default("{}") // Credit allocations per role, etc.
  isPublic       Boolean             @default(false) // Allow public registration
  publicToken    String?             @unique // Shareable token for public access
  defaultCredits Int                 @default(10) // Credits for public voters
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  // Relations
  tenant        Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sprint        Sprint?                @relation(fields: [sprintId], references: [id], onDelete: SetNull)
  problems      VotingSessionProblem[]
  votes         Vote[]
  links         VotingLink[]
  voterSessions VoterSession[]
  groups        VotingSessionGroup[]

  @@index([tenantId])
  @@index([sprintId])
  @@index([status])
  @@index([publicToken])
  @@map("voting_sessions")
}

enum SessionType {
  SPRINT_BASED // Single focus area
  THEMATIC // Mixed problems from multiple areas
}

enum VotingSessionStatus {
  DRAFT // Being set up
  ACTIVE // Open for voting
  CLOSED // Voting complete
  ARCHIVED // Historical record
}

model VotingSessionProblem {
  id              String   @id @default(cuid())
  votingSessionId String
  problemId       String
  preScore        Float? // System-calculated score before voting
  displayOrder    Int      @default(0)
  createdAt       DateTime @default(now())

  // Relations
  votingSession VotingSession @relation(fields: [votingSessionId], references: [id], onDelete: Cascade)
  problem       Problem       @relation(fields: [problemId], references: [id], onDelete: Cascade)

  @@unique([votingSessionId, problemId])
  @@map("voting_session_problems")
}

model Vote {
  id              String   @id @default(cuid())
  votingSessionId String
  problemId       String
  userId          String
  voterGroupId    String? // Track which group this voter belonged to
  creditsAssigned Int
  comment         String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  votingSession VotingSession @relation(fields: [votingSessionId], references: [id], onDelete: Cascade)
  problem       Problem       @relation(fields: [problemId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  voterGroup    VoterGroup?   @relation(fields: [voterGroupId], references: [id], onDelete: SetNull)

  @@unique([votingSessionId, problemId, userId])
  @@index([votingSessionId])
  @@index([voterGroupId])
  @@map("votes")
}

model VotingLink {
  id              String    @id @default(cuid())
  votingSessionId String
  token           String    @unique @default(cuid())
  email           String
  creditsAllowed  Int       @default(10)
  expiresAt       DateTime?
  usedAt          DateTime?
  createdAt       DateTime  @default(now())

  // Relations
  votingSession VotingSession @relation(fields: [votingSessionId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("voting_links")
}

// Tracks voter assignment to sessions (for registered voters)
model VoterSession {
  id              String    @id @default(cuid())
  votingSessionId String
  userId          String
  creditsAllowed  Int       @default(10)
  openedAt        DateTime? // When they first accessed the session
  completedAt     DateTime? // When they finished voting (used all credits or submitted)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  votingSession VotingSession @relation(fields: [votingSessionId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([votingSessionId, userId])
  @@index([userId])
  @@map("voter_sessions")
}

// ============================================================================
// PROJECT MANAGEMENT
// ============================================================================

model ProjectItem {
  id          String            @id @default(cuid())
  tenantId    String
  problemId   String? // Optional link to Problem
  title       String
  description String?           @db.Text
  status      ProjectItemStatus @default(BACKLOG)
  priority    Int               @default(0)
  assignee    String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([tenantId])
  @@index([status])
  @@map("project_items")
}

enum ProjectItemStatus {
  BACKLOG
  IN_PROGRESS
  REVIEW
  DONE
}

// ============================================================================
// SOLUTIONS
// ============================================================================

model Solution {
  id          String         @id @default(cuid())
  tenantId    String
  problemId   String
  title       String
  description String?        @db.Text
  mockups     Json           @default("[]") // Array of mockup URLs/data
  assumptions Json           @default("{}") // Usage assumptions, targets
  status      SolutionStatus @default(DESIGNED)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  problem Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([problemId])
  @@map("solutions")
}

enum SolutionStatus {
  DESIGNED // Initial design
  DEVELOPMENT // Being built
  TESTING // In testing
  LIVE // Deployed to production
  KILLED // Abandoned
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String?
  userId    String?
  action    String
  entity    String
  entityId  String
  changes   Json     @default("{}")
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([entity, entityId])
  @@map("audit_logs")
}

// ============================================================================
// FEATURE MAP
// ============================================================================

model Feature {
  id          String        @id @default(cuid())
  tenantId    String
  featureId   String        // Human-readable: 'checkout-payment-form'

  // Hierarchy
  parentId    String?

  // Metadata
  name        String
  description String?       @db.Text
  status      FeatureStatus @default(ACTIVE)

  // External Links (JSON for flexibility)
  codeLocations Json        @default("[]") // Array of {repo, filePath, lineRange, branch}
  designFiles   Json        @default("[]") // Array of {url, type, name}
  tags          String[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent          Feature?         @relation("FeatureHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children        Feature[]        @relation("FeatureHierarchy")
  analyticsEvents AnalyticsEvent[]

  @@unique([tenantId, featureId])
  @@index([tenantId])
  @@index([parentId])
  @@index([status])
  @@map("features")
}

enum FeatureStatus {
  DRAFT      // Being documented
  ACTIVE     // In production
  DEPRECATED // Scheduled for removal
  ARCHIVED   // Historical record
}

// ============================================================================
// ANALYTICS EVENTS
// ============================================================================

model AnalyticsEvent {
  id         String    @id @default(cuid())
  tenantId   String
  featureId  String?   // May be null for general page events

  eventType  EventType
  eventName  String    // e.g., "click", "view", "complete", "error"

  // Anonymous user tracking
  sessionId  String    // Anonymous session identifier
  deviceId   String?   // Anonymous device fingerprint (optional)

  // Context
  pageUrl    String?
  referrer   String?
  userAgent  String?
  metadata   Json      @default("{}") // Additional event-specific data

  // Timestamps
  occurredAt DateTime  @default(now())
  receivedAt DateTime  @default(now())

  // Relations
  feature    Feature?  @relation(fields: [featureId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([featureId])
  @@index([sessionId])
  @@index([eventType])
  @@index([occurredAt])
  @@index([tenantId, featureId, occurredAt]) // Composite for analytics queries
  @@map("analytics_events")
}

enum EventType {
  FEATURE_VIEW     // User viewed/opened feature
  FEATURE_INTERACT // User interacted (click, input, etc.)
  FEATURE_COMPLETE // User completed workflow
  FEATURE_ERROR    // Error occurred
  FEATURE_EXIT     // User left without completing
  PAGE_VIEW        // General page view
  CUSTOM           // Custom event
}

// ============================================================================
// PLUGIN CONFIGURATION
// ============================================================================

model PluginConfig {
  id             String   @id @default(cuid())
  tenantId       String   @unique

  // API Key for plugin authentication
  apiKey         String   @unique @default(cuid())

  // Global settings
  isEnabled      Boolean  @default(true)

  // Environment settings
  allowedOrigins String[] @default([]) // CORS origins

  // Rate limiting
  eventsPerMinute Int     @default(100)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([apiKey])
  @@map("plugin_configs")
}
